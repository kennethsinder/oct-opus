# Training and Testing

## Training

There is no graphical user interface (GUI) tool for performing training on additional OCTA data since it is assumed you have access to a machine with an NVIDIA graphics processing unit (GPU) such as Compute Canada's [Sharcnet](https://www.sharcnet.ca/) cluster or UWaterloo's [eceUbuntu4](https://ece.uwaterloo.ca/Nexus/arbeau/clients/).

On a system like Sharcnet, which has the Slurm job scheduling system, you'll need to wrap the script with some additional metadata and settings to be able to launch a GPU job properly - on Sharcnet, we have you covered with the <code>[sharcnet.md](sharcnet.md)</code> doc and some included wrapper scripts like <code>[run_job.sh](../run_job.sh)</code>. However, on a system you personally control, like `eceUbuntu4`, you can launch <code>[cgan.py](../cgan.py)</code> directly:

```
python cgan.py train -s 1 -e {number_of_epochs} -d {top_level_data_directory}
```

There are some assumptions about how data is organized in the data you supply under the path `top_level_data_directory` which are clarified in the "Testing/Prediction" section below. Please also note that for training, **both** the `"xzIntensity"` and `"OMAG Bscans"` folders are important, since we need both the OCT images and the OMAG ground truth to be able to perform training with paired images. But for prediction, only the `"xzIntensity"` is required, since you may also want to be able to created predicted OMAG-like images even if real OMAGs don't exist.

By default, training uses the entire data set you provide, and assumes that you have a separate data set you may want to use later in "Testing / Prediction" mode to evaluate how well the model performs after training.

Some important additional command-line flags you should note:

* `-k {num_folds}` performs [K-folds cross-validation](https://en.wikipedia.org/wiki/Cross-validation_(statistics)#k-fold_cross-validation) with K = `num_folds` partitions of the data supplied in. In this mode, predicted images _are_ generated in the `experiment-<date & time>/` directory generated by training.
* `-c {checkpoint_dir}` takes in a path to an existing folder with training checkpoints created from prior training, and what it does is it causes the latest checkpoint from that folder to be loaded before training starts. This keeps the progress from past training and performs a "software update" (i.e. runs _additional_ epochs of training on top of the training done so far). This is useful in event of a crash or if existing training was good but additional data should be supplied to finish up the training.

## Testing / Prediction

We have separate documentation for generating predicted images using the GUI tool under <code>[gui.md](gui.md)</code>, so the remainder of this section assumes you are interested in the command-line interface (CLI) instead.

To be able to generate predicted OMAG-like cross-sections from B-scans using a trained model, simply call <code>[cgan.py](../cgan.py)</code> via the following command-line options.

```
python cgan.py predict -d {top_level_data_directory} -c {checkpoint_directory}
```

A more concrete example looks like this.

```
python cgan.py predict -d ../sample_datasets -c ./training_checkpoints
```

Note that `top_level_data_directory` should have the datasets nested like so.
Actual image files not shown for brevity.
```
sample_datasets/
├── 2015-10-27___512_2048_Horizontal_Images58
│   ├── Capillary\ Red\ Layer.tiff
│   ├── OMAG\ Bscans
│   └── xzIntensity
├── 2015-10-27___512_2048_Horizontal_Images6
│   ├── Capillary\ Red\ Layer.tiff
│   ├── OMAG\ Bscans
│   └── xzIntensity
├── 2015-10-27___512_2048_Horizontal_Images67
│   ├── Capillary\ Red\ Layer.tiff
│   ├── OMAG\ Bscans
│   └── xzIntensity
├── 2015-10-27___512_2048_Horizontal_Images72
│   ├── Capillary\ Red\ Layer.tiff
│   ├── OMAG\ Bscans
│   └── xzIntensity
└── 2015-10-27___512_2048_Horizontal_Images73
    ├── Capillary\ Red\ Layer.tiff
    ├── OMAG\ Bscans
    └── xzIntensity
```

> :warning: The function `cgan/utils.py/generate_inferred_images` assumes that OMAG directories are named `OMAG Bscans`.

Similarly, the `checkpoint_directory` might look like this.
The checkpoints should automatically be generated as training is run (see training instructions). 
Again, the actual image files are not shown for brevity.

```
training_checkpoints/
├── checkpoint
├── ckpt-25.data-00000-of-00002
├── ckpt-25.data-00001-of-00002
└── ckpt-25.index
```

The resulting output is stored in an `experiment-{timestamp}` directory.
```
experiment-2020-05-16-171703/
├── 2015-10-27___512_2048_Horizontal_Images58
├── 2015-10-27___512_2048_Horizontal_Images6
├── 2015-10-27___512_2048_Horizontal_Images67
├── 2015-10-27___512_2048_Horizontal_Images72
├── 2015-10-27___512_2048_Horizontal_Images73
├── README.md
└── logs
```

> :warning: Image generation - especially for large datasets - tends to take a very long time.
